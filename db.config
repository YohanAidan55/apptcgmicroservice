/* ============================================================
   1. CREATION DES SCHEMAS
   ============================================================ */

CREATE SCHEMA IF NOT EXISTS userservice;
CREATE SCHEMA IF NOT EXISTS collectionservice;
CREATE SCHEMA IF NOT EXISTS productservice;


/* ============================================================
   2. CREATION DES USERS
   ============================================================ */

CREATE USER user_userservice WITH PASSWORD 'password_userservice';
CREATE USER user_collectionservice WITH PASSWORD 'password_collectionservice';
CREATE USER user_productservice WITH PASSWORD 'password_productservice';
CREATE USER user_global WITH PASSWORD 'password_global';


/* ============================================================
   3. SCHEMA PAR DEFAUT (search_path)
   ============================================================ */

ALTER ROLE user_userservice
SET search_path = userservice;

ALTER ROLE user_collectionservice
SET search_path = collectionservice;

ALTER ROLE user_productservice
SET search_path = productservice;

/* ============================================================
   4. DROITS POUR CHAQUE SERVICE (LIQUIBASE COMPATIBLE)
   ============================================================ */

-- ========================
-- UserService
-- ========================
GRANT USAGE, CREATE ON SCHEMA userservice TO user_userservice;

GRANT SELECT, INSERT, UPDATE, DELETE
ON ALL TABLES IN SCHEMA userservice TO user_userservice;

GRANT USAGE, SELECT
ON ALL SEQUENCES IN SCHEMA userservice TO user_userservice;

ALTER DEFAULT PRIVILEGES IN SCHEMA userservice
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO user_userservice;

ALTER DEFAULT PRIVILEGES IN SCHEMA userservice
GRANT USAGE, SELECT ON SEQUENCES TO user_userservice;


-- ========================
-- CollectionService
-- ========================
GRANT USAGE, CREATE ON SCHEMA collectionservice TO user_collectionservice;

GRANT SELECT, INSERT, UPDATE, DELETE
ON ALL TABLES IN SCHEMA collectionservice TO user_collectionservice;

GRANT USAGE, SELECT
ON ALL SEQUENCES IN SCHEMA collectionservice TO user_collectionservice;

ALTER DEFAULT PRIVILEGES IN SCHEMA collectionservice
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO user_collectionservice;

ALTER DEFAULT PRIVILEGES IN SCHEMA collectionservice
GRANT USAGE, SELECT ON SEQUENCES TO user_collectionservice;


-- ========================
-- ProductService
-- ========================
GRANT USAGE, CREATE ON SCHEMA productservice TO user_productservice;

GRANT SELECT, INSERT, UPDATE, DELETE
ON ALL TABLES IN SCHEMA productservice TO user_productservice;

GRANT USAGE, SELECT
ON ALL SEQUENCES IN SCHEMA productservice TO user_productservice;

ALTER DEFAULT PRIVILEGES IN SCHEMA productservice
GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO user_productservice;

ALTER DEFAULT PRIVILEGES IN SCHEMA productservice
GRANT USAGE, SELECT ON SEQUENCES TO user_productservice;


/* ============================================================
   6. ISOLATION STRICTE ENTRE SERVICES
   ============================================================ */

-- user_userservice
REVOKE ALL ON SCHEMA collectionservice FROM user_userservice;
REVOKE ALL ON SCHEMA productservice FROM user_userservice;

-- user_collectionservice
REVOKE ALL ON SCHEMA userservice FROM user_collectionservice;
REVOKE ALL ON SCHEMA productservice FROM user_collectionservice;

-- user_productservice
REVOKE ALL ON SCHEMA userservice FROM user_productservice;
REVOKE ALL ON SCHEMA collectionservice FROM user_productservice;
